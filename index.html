<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiTwitch Live Selector</title>
    <link rel="icon" type="image/x-icon" href="multitwitch.ico">
    <style>
        body {
            background-color: #0e0e10;
            color: #e0e0e0;
            font-family: 'Arial', sans-serif;
            text-align: center;
            padding: 0;
            margin: 0;
			overflow: hidden;
        }

        h1 {
            font-size: 28px;
            margin: 0;
            font-weight: 700;
            letter-spacing: .5px;
            color: #ffffff; /* revert to plain white */
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        h1:after { display:none; }

        #channelList {
            display: inline-block;
            text-align: left;
            background: #1b1b1f;
            padding: 6px 22px 6px;
            border-radius: 14px;
            max-height: 73vh;
            width: 880px; /* widened */
            overflow-y: auto;
            box-shadow: 0px 4px 18px rgba(0,0,0,0.35);
            transition: transform .18s ease, box-shadow .25s ease;
        }

        .channel-container {
            display:flex;
            align-items:center;
            gap:14px; /* decreased gap */
            margin:8px 0;
            padding:6px 10px; /* decreased padding */
            background:#24242a;
            border-radius:12px;
            cursor:pointer;
            transition: background .25s, transform .18s ease, box-shadow .25s;
            border:1px solid #303036;
        }
        .channel-container:hover { background:#2a2a30; box-shadow:0 6px 14px -6px rgba(0,0,0,.6); }
        .channel-container.selected {
            background:#a970ff;
            color:#fff;
            border-color:#b98bff;
        }
        .channel-container.selected .stream-title { color:#f3e9ff; }
        .channel-container.selected .stream-uptime { color:#e2d4fa; }

        .stream-thumbnail {
            width:210px; /* slightly enlarged thumbnail */
            height:118px;
            border-radius:8px;
            box-shadow:0 4px 10px rgba(0,0,0,.35);
        }

        .channel-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .channel-name {
            font-size:18px;
            font-weight:600;
            margin-bottom:1px;
        }

        .stream-title {
            font-size:13px;
            color:#cfcfd4;
            max-width:560px; /* expanded max width */
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
            margin-top:0;
        }

        .stream-uptime {
            font-size:12px;
            color:#8d8d96;
            margin-top:2px;
        }
		.popup { /* repurpose as anchored tooltip container */
            position: absolute;
            top: 0;
            left: 0;
            display: none;
            z-index: 999;
            width: auto;
            max-width: 360px;
        }
        .popup-content {
            background: #201f24;
            border: 1px solid #34323a;
            color: #e9e6f2;
            padding: 6px 10px 8px;
            border-radius: 10px;
            box-shadow: 0 6px 20px -4px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.04);
            font-size: 14px;
            line-height: 1.5;
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            position: relative;
            animation: popIn .16s ease;
        }
        .popup-content:before { /* small arrow */
            content: "";
            position: absolute;
            top: -6px;
            left: var(--arrow-left, 22px);
            width: 12px;
            height: 12px;
            background: inherit;
            transform: rotate(45deg);
            border-top: 1px solid #34323a;
            border-left: 1px solid #34323a;
        }
        @keyframes popIn { from { opacity:0; transform:translateY(-4px) scale(.96);} to { opacity:1; transform:translateY(0) scale(1);} }
		#generate {
			display: none;
			background:#a970ff;
			color:#fff;
			padding:14px 32px;
			border:none;
			border-radius:30px;
			font-size:16px;
			font-weight:600;
			cursor:pointer;
			margin:20px auto 20px;
			transition: background .25s, transform .18s ease, box-shadow .25s;
            box-shadow:0 6px 18px -6px rgba(169,112,255,0.6);
		}
			
		#generate:hover { background:#b685ff; transform:translateY(-3px) scale(1.04); box-shadow:0 10px 26px -8px rgba(169,112,255,0.75); }
		#generate:active { transform:translateY(-1px) scale(1.01); }

		#channelList::-webkit-scrollbar {
			width: 10px;
		}
		
		#channelList::-webkit-scrollbar-track {
			background: #252525;
			border-radius: 10px;
		}
		
		#channelList::-webkit-scrollbar-thumb {
			background: #D9D9D9;
			border-radius: 10px;
			transition: background 0.3s;
		}
		
		#channelList::-webkit-scrollbar-thumb:hover {
			background: #BFBFBF;
		}
		#profileContainer {
			position: absolute;
			top: 10px;
			right: 10px;
			width: 40px;
			height: 40px;
			border-radius: 50%;
			overflow: hidden;
			cursor: pointer;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
			transition: transform .18s ease, box-shadow .25s;
		}
		
		#profileContainer:hover { transform:translateY(-2px) scale(1.12); box-shadow:0 6px 20px -6px rgba(169,112,255,.65); }
		
		#profilePic {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}
		
		#helpBtn {
			position: absolute;
			top: 10px;
			right: 60px;
			width: 40px;
			height: 40px;
			font-size: 20px;
			font-weight: bold;
			border: none;
			border-radius: 50%;
			background-color:#a970ff;
			color: white;
			cursor: pointer;
			box-shadow:0 0 0 0 rgba(169,112,255,.4), 0 4px 14px -4px rgba(0,0,0,.6);
			transition: background .25s, transform .18s ease, box-shadow .3s;
		}
		
		#helpBtn:hover { background-color:#b685ff; transform:translateY(-2px) scale(1.1); box-shadow:0 8px 26px -10px rgba(169,112,255,.9); }

		#logoutBtn {
            background:#2d2d34;
            color:#e8ddff;
            border:1px solid #3d3d46;
            padding:5px 12px;
            border-radius:6px;
            font-size:12px;
            cursor:pointer;
            margin-left:10px;
            transition:background .25s,border-color .25s,color .25s, transform .18s ease;
        }
        #logoutBtn:hover { background:#a970ff; border-color:#a970ff; color:#fff; transform:translateY(-2px); }

        .profile-row { display:flex; align-items:center; font-size:15px; font-weight:600; }

        .top-bar { 
            background:#18181b; 
            width:100%;
            padding:10px 0;
            margin:0;
            border-radius:0;
            position:static;
        }
        .top-bar-inner {
            max-width:none;
            margin:0;
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:0 22px;
        }
        .nav-left { display:flex; align-items:center; gap:18px; }
        .nav-center {
            flex:1;
            text-align:center;
            position:static;
            transform:none;
            pointer-events:auto;
        }
        .nav-center h1 { pointer-events:auto; }
        .nav-right { display:flex; align-items:center; gap:14px; }
        h1 { margin:0; font-size:28px; }
        .twitch-logo { width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform .2s ease; }
        .twitch-logo:hover { transform:scale(1.08) rotate(-2deg); }
        .twitch-logo svg { display:block; }
        .popup-content {
            text-align:left;
        }
        .popup-content a { color: #a970ff; text-decoration: underline; }
        .popup-content a:visited { color: #a970ff; }
        .popup-content ul {
            list-style:disc;
            padding-left:20px;
            margin:4px 0 2px;
        }
        .popup-content ul li {
            padding:4px 0;
            border-bottom:none;
        }
        #helpBtn,
        #profileContainer {
            position:static;
        }
        .popup-content.help-wide { max-width:500px; width:auto; }
    </style>
</head>
<body>
    <div class="top-bar">
      <div class="top-bar-inner">
        <div class="nav-left">
          <a href="https://twitch.tv" target="_blank" rel="noopener" class="twitch-logo" title="Twitch Home">
            <div class="tw-animated-glitch-logo">
              <figure style="margin:0;">
                <svg overflow="visible" width="40" height="40" viewBox="0 0 40 40">
                  <g>
                    <polygon points="13 8 8 13 8 31 14 31 14 36 19 31 23 31 32 22 32 8" fill="#a970ff"></polygon>
                    <polygon points="26 25 30 21 30 10 14 10 14 25 18 25 18 29 22 25" fill="#0e0e10"></polygon>
                    <g fill="#a970ff"><path d="M20,14 L22,14 L22,20 L20,20 L20,14 Z M27,14 L27,20 L25,20 L25,14 L27,14 Z"/></g>
                  </g>
                </svg>
              </figure>
            </div>
          </a>
        </div>
        <div class="nav-center"><h1>MultiTwitch Live Channel Selector</h1></div>
        <div class="nav-right">
            <button id="helpBtn">?</button>
            <div id="profileContainer">
                <img id="profilePic" src="" alt="Profile" title="Profile" />
            </div>
        </div>
      </div>
    </div>
	
	<div id="popup" class="popup">
		<div class="popup-content">
			<p id="popupText">Help</p>
		</div>
	</div>
    
    <button id="generate" style="display:none;">Generate MultiTwitch Link</button>
	<div id="channelList"></div>

    <script>
        const clientId = "8nsznpvw3o37hr4sbfh5gn6wxdymre"; // Twitch Client ID
        const redirectUri = "https://blake-goofy.github.io/MultiTwitchSelector/"; // Redirects back to this page
		const popup = document.getElementById("popup");
		const popupText = document.getElementById("popupText");
		
		        let accessToken = localStorage.getItem("twitch_access_token") || null;
        let userId = null;
        let selectedChannels = new Set();

        function authenticateTwitch() {
            window.location.href = `https://id.twitch.tv/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=user:read:follows`;
        }

        function checkTwitchLogin() {
			const hash = window.location.hash;
		
			// Check if the URL contains an access token
			if (hash.includes("access_token")) {
			accessToken = new URLSearchParams(hash.substring(1)).get("access_token");
		
				// Store the token so the user stays logged in
				localStorage.setItem("twitch_access_token", accessToken);
		
				// Remove the token from the URL for a cleaner experience
				window.history.replaceState({}, document.title, window.location.pathname);
		
				// Now fetch the user ID
				fetchUserId();
			} else if (accessToken) {
				// If token is already stored, fetch user ID directly
				fetchUserId();
			} else {
				// If no token is found, redirect to Twitch login
				authenticateTwitch();
			}
		}
		
		// Replace togglePopup with anchored version
		function togglePopup(anchorEl, html, opts={}) {
            if (!anchorEl || typeof anchorEl.getBoundingClientRect !== 'function') {
                console.error('Invalid anchorEl passed to togglePopup:', anchorEl);
                return;
            }
            const popup = document.getElementById('popup');
            const popupText = document.getElementById('popupText');
            const contentEl = popup.querySelector('.popup-content');
            contentEl.classList.remove('compact','help-wide');
            if (popup.dataset.anchorId === anchorEl.id && popup.style.display === 'block') {
                popup.style.display = 'none';
                popup.dataset.anchorId = '';
                return;
            }
            popupText.innerHTML = html;
            if(opts.compact) contentEl.classList.add('compact');
            if(opts.help) contentEl.classList.add('help-wide','compact');
            popup.style.display = 'block';
            popup.dataset.anchorId = anchorEl.id;
            const rect = anchorEl.getBoundingClientRect();
            const scrollY = window.scrollY || document.documentElement.scrollTop;
            const scrollX = window.scrollX || document.documentElement.scrollLeft;
            const desiredCenter = rect.left + rect.width/2 + scrollX;
            const popupWidth = popup.offsetWidth || 360;
            const left = desiredCenter - popupWidth/2;
            const minLeft = scrollX + 20;
            const maxLeft = scrollX + window.innerWidth - popupWidth - 20;
            const finalLeft = Math.min(Math.max(left, minLeft), maxLeft);
            popup.style.left = finalLeft + 'px';
            popup.style.top = (rect.bottom + 6 + scrollY) + 'px';
            const arrowPos = (desiredCenter - finalLeft) - 6;
            contentEl.style.setProperty('--arrow-left', arrowPos + 'px');
        }

        // Global click to close if clicking outside
        document.addEventListener('click', (e) => {
            const popup = document.getElementById('popup');
            if (!popup.contains(e.target) && e.target.id !== 'helpBtn' && !document.getElementById('profileContainer').contains(e.target)) {
                popup.style.display = 'none';
                popup.dataset.anchorId='';
            }
        });
        window.addEventListener('resize', () => { const popup = document.getElementById('popup'); if(popup.style.display==='block'){ popup.style.display='none'; }});

        async function fetchUserId() {
			try {
				const response = await fetch("https://api.twitch.tv/helix/users", {
					headers: {
						"Authorization": `Bearer ${accessToken}`,
						"Client-Id": clientId
					}
				});
				const data = await response.json();
				if (data.data && data.data.length > 0) {
					userId = data.data[0].id;
					const user = data.data[0];
		
					// Set profile picture
					const profilePic = document.getElementById("profilePic");
					profilePic.src = user.profile_image_url;
					
					// Show channel name on click
					document.getElementById("profileContainer").addEventListener("click", () => {
						togglePopup(`Logged in as: ${user.display_name}`);
					});
		
					fetchFollowedChannels();
				} else {
					throw new Error("User data not found.");
				}
			} catch (error) {
				console.error("Error fetching user ID:", error);
				localStorage.removeItem("twitch_access_token");
				authenticateTwitch(); // Retry login if the token is invalid
			}
		}


        async function fetchFollowedChannels() {
            try {
                const response = await fetch(`https://api.twitch.tv/helix/channels/followed?user_id=${userId}&first=100`, {
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Client-Id": clientId
                    }
                });
                const data = await response.json();
                const channelIds = data.data.map(channel => channel.broadcaster_id);
                checkLiveChannels(channelIds);
            } catch (error) {
                console.error("Error fetching followed channels:", error);
            }
        }

        async function checkLiveChannels(channelIds) {
            const url = `https://api.twitch.tv/helix/streams?` + channelIds.map(id => `user_id=${id}`).join("&");
            const response = await fetch(url, {
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Client-Id": clientId
                }
            });
            const data = await response.json();
            displayLiveChannels(data.data);
        }

        function calculateUptime(startedAt) {
            const start = new Date(startedAt);
            const now = new Date();
            const diffMs = now - start;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            return `${diffHours}h ${diffMinutes}m`;
        }

        function displayLiveChannels(liveChannelsData) {
			const channelListDiv = document.getElementById("channelList");
			// channelListDiv.innerHTML = "<h3>Live Channels</h3>";
			
			if (liveChannelsData.length === 0) {
				channelListDiv.innerHTML += "<p>No live channels</p>";
				return;
			}
			
			liveChannelsData.forEach(stream => {
				const container = document.createElement("div");
				container.classList.add("channel-container");
				container.dataset.channel = stream.user_login;
				container.addEventListener("click", () => toggleSelection(container, stream.user_login));
				
				// Double-click event to open MultiTwitch with that channel
				container.addEventListener("dblclick", () => {
					window.open(`https://www.multitwitch.tv/${stream.user_login}?darkmode`, "_blank");
				});

                // Middle-click (auxclick) event (button === 1)
                container.addEventListener("auxclick", (e) => {
                    if (e.button === 1) { // middle mouse
                        window.open(`https://www.multitwitch.tv/${stream.user_login}?darkmode`, "_blank");
                    }
                });
				
				const thumbnail = document.createElement("img");
				thumbnail.classList.add("stream-thumbnail");
				thumbnail.src = stream.thumbnail_url.replace("{width}", "160").replace("{height}", "90"); 
				thumbnail.alt = `${stream.user_login}'s stream thumbnail`;
				
				const infoContainer = document.createElement("div");
				infoContainer.classList.add("channel-info");
				
				const channelName = document.createElement("p");
				channelName.classList.add("channel-name");
				channelName.textContent = stream.user_login;
				
				const title = document.createElement("p");
				title.classList.add("stream-title");
				title.textContent = stream.title;
				
				const uptime = document.createElement("p");
				uptime.classList.add("stream-uptime");
				uptime.textContent = `Live for ${calculateUptime(stream.started_at)}`;
				
				infoContainer.appendChild(channelName);
				infoContainer.appendChild(title);
				infoContainer.appendChild(uptime);
				container.appendChild(thumbnail);
				container.appendChild(infoContainer);
				channelListDiv.appendChild(container);
			});
			
			document.getElementById("generate").style.display = "block";
            document.getElementById("generate").disabled = selectedChannels.size === 0;
		}

        function toggleSelection(container, channel) {
            if (selectedChannels.has(channel)) {
                selectedChannels.delete(channel);
                container.classList.remove("selected");
            } else {
                selectedChannels.add(channel);
                container.classList.add("selected");
            }
            const generateBtn = document.getElementById('generate');
            generateBtn.disabled = selectedChannels.size === 0;
        }

        document.getElementById("generate").addEventListener("click", () => {
            if (selectedChannels.size > 0) {
                window.open(`https://www.multitwitch.tv/${Array.from(selectedChannels).join("/")}?darkmode`, "_blank");
                selectedChannels.clear();
                document.querySelectorAll(".channel-container").forEach(container => container.classList.remove("selected"));
                document.getElementById('generate').disabled = true;
            }
        });

        // Add Enter key to trigger generate
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const generateBtn = document.getElementById('generate');
                if (generateBtn.style.display !== 'none' && !generateBtn.disabled) {
                    generateBtn.click();
                }
            }
        });

        checkTwitchLogin();

        // Enhance profile popup after user data retrieval by wrapping existing fetchUserId
        (function(){
            const originalFetchUserId = fetchUserId;
            fetchUserId = async function(){
                try {
                    const response = await fetch("https://api.twitch.tv/helix/users", { headers: { "Authorization": `Bearer ${accessToken}`, "Client-Id": clientId } });
                    const data = await response.json();
                    if (data.data && data.data.length > 0) {
                        userId = data.data[0].id;
                        const user = data.data[0];
                        const profilePic = document.getElementById("profilePic");
                        profilePic.src = user.profile_image_url;
                        const profileContainer = document.getElementById("profileContainer");
                        profileContainer.onclick = function(e) {
                            e.preventDefault();
                            togglePopup(profileContainer, `<div class='profile-row'>${user.display_name} <button id='logoutBtn'>Logout</button></div>`);
                            const btn = document.getElementById('logoutBtn');
                            if(btn){ btn.onclick = logout; }
                        };
                        fetchFollowedChannels();
                    } else { throw new Error("User data not found."); }
                } catch(err){
                    console.error("Error fetching user ID:", err);
                    localStorage.removeItem('twitch_access_token');
                    authenticateTwitch();
                }
            }
        })();

        // Update help button listener to anchor properly
        (function(){
            const helpBtn = document.getElementById('helpBtn');
            helpBtn.replaceWith(helpBtn.cloneNode(true));
            const newHelpBtn = document.getElementById('helpBtn');
            newHelpBtn.addEventListener('click', function() {
                togglePopup(this, `<ul><li>Select channels by clicking</li><li>Generate Link opens all selected</li><li>Double / Middle click opens instantly</li></ul><div style="text-align:center; color:#888;">GitHub README <a href="https://github.com/Blake-goofy/MultiTwitchSelector#readme" target="_blank">here</a></div><div style="text-align:center; color:#888;">blake13blake@gmail.com</div>`, {help:true});
            });
        })();

        // Restore middle-click open in new tab for channel containers
        function displayLiveChannels(liveChannelsData) {
            const channelListDiv = document.getElementById("channelList");
            channelListDiv.innerHTML = "";
            if (liveChannelsData.length === 0) {
                channelListDiv.innerHTML += "<p>No live channels</p>";
                return;
            }
            liveChannelsData.forEach(stream => {
                const container = document.createElement("div");
                container.classList.add("channel-container");
                container.dataset.channel = stream.user_login;
                container.addEventListener("click", () => toggleSelection(container, stream.user_login));
                container.addEventListener("dblclick", () => {
                    window.open(`https://www.multitwitch.tv/${stream.user_login}?darkmode`, "_blank");
                });
                container.addEventListener("auxclick", (e) => {
                    if (e.button === 1) {
                        e.preventDefault();
                        window.open(`https://www.multitwitch.tv/${stream.user_login}?darkmode`, "_blank");
                    }
                });
                const thumbnail = document.createElement("img");
                thumbnail.classList.add("stream-thumbnail");
                thumbnail.src = stream.thumbnail_url.replace("{width}", "210").replace("{height}", "118");
                thumbnail.alt = `${stream.user_login}'s stream thumbnail`;
                const infoContainer = document.createElement("div");
                infoContainer.classList.add("channel-info");
                const channelName = document.createElement("p");
                channelName.classList.add("channel-name");
                channelName.textContent = stream.user_login;
                const title = document.createElement("p");
                title.classList.add("stream-title");
                title.textContent = stream.title;
                const uptime = document.createElement("p");
                uptime.classList.add("stream-uptime");
                uptime.textContent = `Live for ${calculateUptime(stream.started_at)}`;
                infoContainer.appendChild(channelName);
                infoContainer.appendChild(title);
                infoContainer.appendChild(uptime);
                container.appendChild(thumbnail);
                container.appendChild(infoContainer);
                channelListDiv.appendChild(container);
            });
            document.getElementById("generate").style.display = "block";
            document.getElementById("generate").disabled = selectedChannels.size === 0;
        }
    </script>

</body>
</html>
