<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiTwitch Live Selector</title>
    <link rel="icon" type="image/x-icon" href="multitwitch.ico">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Arial', sans-serif;
            text-align: center;
            padding: 20px;
			overflow: hidden;
        }

        h1 {
            font-size: 42px;
            margin: 30px 0 25px;
            font-weight: 800;
            letter-spacing: 1px;
            background: linear-gradient(90deg,#66ffa6,#00c853,#18ffff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            position: relative;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        h1:after {
            content: "";
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -10px;
            width: 260px;
            height: 3px;
            background: linear-gradient(90deg,#00c853,#18ffff,#00c853);
            border-radius: 2px;
            box-shadow: 0 0 12px rgba(0,200,83,0.4);
        }

        #channelList {
            margin-top: 20px;
            display: inline-block;
            text-align: left;
            background: #1e1e1e;
            padding: 15px;
            border-radius: 10px;
			max-height: 70vh;
			height: auto;
			width: 500px;
			overflow-y: auto;
			box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
        }

        .channel-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 5px;
            margin-bottom: 5px;
            padding: 5px;
            background: #252525;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .channel-container.selected {
            background: #00c853;
            color: #000;
        }

        .stream-thumbnail {
            width: 160px;
            height: 90px;
            border-radius: 5px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        }

        .channel-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .channel-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .stream-title {
            font-size: 14px;
            color: #bbbbbb;
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 0;
        }

        .stream-uptime {
            font-size: 12px;
            color: #888888;
            margin-top: 4px;
        }
		.popup { /* repurpose as anchored tooltip container */
            position: absolute;
            top: 0;
            left: 0;
            display: none;
            z-index: 999;
            width: auto;
            max-width: 360px;
        }
        .popup-content {
            background: #1e1e1e;
            border: 1px solid #2c2c2c;
            color: #e0e0e0;
            padding: 14px 16px 16px;
            border-radius: 10px;
            box-shadow: 0 6px 20px -4px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.04);
            font-size: 14px;
            line-height: 1.5;
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            position: relative;
            animation: popIn .16s ease;
        }
        .popup-content:before { /* small arrow */
            content: "";
            position: absolute;
            top: -6px;
            left: 22px;
            width: 12px;
            height: 12px;
            background: inherit;
            transform: rotate(45deg);
            border-top: 1px solid #2c2c2c;
            border-left: 1px solid #2c2c2c;
        }
        @keyframes popIn { from { opacity:0; transform:translateY(-4px) scale(.96);} to { opacity:1; transform:translateY(0) scale(1);} }
        #generate {
			display: none;
			background-color: #00c853;
			color: white;
			padding: 10px 20px;
			border: none;
			border-radius: 5px;
			font-size: 16px;
			cursor: pointer;
			margin: 20px auto;
		}
			
		#generate:hover {
			background-color: #00af48;
		}
		
		#channelList::-webkit-scrollbar {
			width: 10px;
		}
		
		#channelList::-webkit-scrollbar-track {
			background: #252525;
			border-radius: 10px;
		}
		
		#channelList::-webkit-scrollbar-thumb {
			background: #D9D9D9;
			border-radius: 10px;
			transition: background 0.3s;
		}
		
		#channelList::-webkit-scrollbar-thumb:hover {
			background: #BFBFBF;
		}
		#profileContainer {
			position: absolute;
			top: 10px;
			right: 10px;
			width: 40px;
			height: 40px;
			border-radius: 50%;
			overflow: hidden;
			cursor: pointer;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
			transition: transform 0.2s;
		}
		
		#profileContainer:hover {
			transform: scale(1.1);
		}
		
		#profilePic {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}
		
		#helpBtn {
			position: absolute;
			top: 10px;
			right: 60px;
			width: 40px;
			height: 40px;
			font-size: 20px;
			font-weight: bold;
			border: none;
			border-radius: 50%;
			background-color: #00c853;
			color: white;
			cursor: pointer;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
			transition: background 0.3s, transform 0.2s;
		}
		
		#helpBtn:hover {
			background-color: #00af48;
			transform: scale(1.1);
		}
		#logoutBtn {
            background:#272727;
            color:#eee;
            border:1px solid #3a3a3a;
            padding:4px 10px;
            border-radius:6px;
            font-size:12px;
            cursor:pointer;
            margin-left:10px;
            transition:background .2s,border-color .2s,color .2s;
        }
        #logoutBtn:hover { background:#00c853; color:#000; border-color:#00c853; }
        .profile-row { display:flex; align-items:center; font-size:15px; font-weight:600; }
    </style>
</head>
<body>
	<div id="profileContainer">
		<img id="profilePic" src="" alt="Profile" title="Click to see your channel name">
	</div>
	
	<button id="helpBtn">?</button>

    <h1>MultiTwitch Live Channel Selector</h1>
	
	<div id="popup" class="popup">
		<div class="popup-content">
			<p id="popupText">Help</p>
		</div>
	</div>
    
    <button id="generate" style="display:none;">Generate MultiTwitch Link</button>
	<div id="channelList"></div>

    <script>
        const clientId = "8nsznpvw3o37hr4sbfh5gn6wxdymre"; // Twitch Client ID
        const redirectUri = "https://blake-goofy.github.io/MultiTwitchSelector/"; // Redirects back to this page
		const popup = document.getElementById("popup");
		const popupText = document.getElementById("popupText");
		
		        let accessToken = localStorage.getItem("twitch_access_token") || null;
        let userId = null;
        let selectedChannels = new Set();

        function authenticateTwitch() {
            window.location.href = `https://id.twitch.tv/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=user:read:follows`;
        }

        function checkTwitchLogin() {
			const hash = window.location.hash;
		
			// Check if the URL contains an access token
			if (hash.includes("access_token")) {
				accessToken = new URLSearchParams(hash.substring(1)).get("access_token");
		
				// Store the token so the user stays logged in
				localStorage.setItem("twitch_access_token", accessToken);
		
				// Remove the token from the URL for a cleaner experience
				window.history.replaceState({}, document.title, window.location.pathname);
		
				// Now fetch the user ID
				fetchUserId();
			} else if (accessToken) {
				// If token is already stored, fetch user ID directly
				fetchUserId();
			} else {
				// If no token is found, redirect to Twitch login
				authenticateTwitch();
			}
		}
		
		// Replace togglePopup with anchored version
		function togglePopup(anchorEl, html) {
            const popup = document.getElementById('popup');
            const popupText = document.getElementById('popupText');
            if (popup.dataset.anchorId === anchorEl.id && popup.style.display === 'block') {
                popup.style.display = 'none';
                popup.dataset.anchorId = '';
                return;
            }
            popupText.innerHTML = html;
            popup.style.display = 'block';
            popup.dataset.anchorId = anchorEl.id;
            // position
            const rect = anchorEl.getBoundingClientRect();
            const scrollY = window.scrollY || document.documentElement.scrollTop;
            const scrollX = window.scrollX || document.documentElement.scrollLeft;
            popup.style.top = (rect.bottom + 8 + scrollY) + 'px';
            popup.style.left = (rect.left + scrollX) + 'px';
        }

        // Global click to close if clicking outside
        document.addEventListener('click', (e) => {
            const popup = document.getElementById('popup');
            if (!popup.contains(e.target) && e.target.id !== 'helpBtn' && !document.getElementById('profileContainer').contains(e.target)) {
                popup.style.display = 'none';
                popup.dataset.anchorId='';
            }
        });
        window.addEventListener('resize', () => { const popup = document.getElementById('popup'); if(popup.style.display==='block'){ popup.style.display='none'; }});

        async function fetchUserId() {
			try {
				const response = await fetch("https://api.twitch.tv/helix/users", {
					headers: {
						"Authorization": `Bearer ${accessToken}`,
						"Client-Id": clientId
					}
				});
				const data = await response.json();
				if (data.data && data.data.length > 0) {
					userId = data.data[0].id;
					const user = data.data[0];
		
					// Set profile picture
					const profilePic = document.getElementById("profilePic");
					profilePic.src = user.profile_image_url;
					
					// Show channel name on click
					document.getElementById("profileContainer").addEventListener("click", () => {
						togglePopup(`Logged in as: ${user.display_name}`);
					});
		
					fetchFollowedChannels();
				} else {
					throw new Error("User data not found.");
				}
			} catch (error) {
				console.error("Error fetching user ID:", error);
				localStorage.removeItem("twitch_access_token");
				authenticateTwitch(); // Retry login if the token is invalid
			}
		}


        async function fetchFollowedChannels() {
            try {
                const response = await fetch(`https://api.twitch.tv/helix/channels/followed?user_id=${userId}&first=100`, {
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Client-Id": clientId
                    }
                });
                const data = await response.json();
                const channelIds = data.data.map(channel => channel.broadcaster_id);
                checkLiveChannels(channelIds);
            } catch (error) {
                console.error("Error fetching followed channels:", error);
            }
        }

        async function checkLiveChannels(channelIds) {
            const url = `https://api.twitch.tv/helix/streams?` + channelIds.map(id => `user_id=${id}`).join("&");
            const response = await fetch(url, {
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Client-Id": clientId
                }
            });
            const data = await response.json();
            displayLiveChannels(data.data);
        }

        function calculateUptime(startedAt) {
            const start = new Date(startedAt);
            const now = new Date();
            const diffMs = now - start;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            return `${diffHours}h ${diffMinutes}m`;
        }

        function displayLiveChannels(liveChannelsData) {
			const channelListDiv = document.getElementById("channelList");
			// channelListDiv.innerHTML = "<h3>Live Channels</h3>";
			
			if (liveChannelsData.length === 0) {
				channelListDiv.innerHTML += "<p>No live channels</p>";
				return;
			}
			
			liveChannelsData.forEach(stream => {
				const container = document.createElement("div");
				container.classList.add("channel-container");
				container.dataset.channel = stream.user_login;
				container.addEventListener("click", () => toggleSelection(container, stream.user_login));
				
				// Double-click event to open MultiTwitch with that channel
				container.addEventListener("dblclick", () => {
					window.open(`https://www.multitwitch.tv/${stream.user_login}?darkmode`, "_blank");
				});

                // Middle-click (auxclick) event (button === 1)
                container.addEventListener("auxclick", (e) => {
                    if (e.button === 1) { // middle mouse
                        window.open(`https://www.multitwitch.tv/${stream.user_login}?darkmode`, "_blank");
                    }
                });
				
				const thumbnail = document.createElement("img");
				thumbnail.classList.add("stream-thumbnail");
				thumbnail.src = stream.thumbnail_url.replace("{width}", "160").replace("{height}", "90"); 
				thumbnail.alt = `${stream.user_login}'s stream thumbnail`;
				
				const infoContainer = document.createElement("div");
				infoContainer.classList.add("channel-info");
				
				const channelName = document.createElement("p");
				channelName.classList.add("channel-name");
				channelName.textContent = stream.user_login;
				
				const title = document.createElement("p");
				title.classList.add("stream-title");
				title.textContent = stream.title;
				
				const uptime = document.createElement("p");
				uptime.classList.add("stream-uptime");
				uptime.textContent = `Live for ${calculateUptime(stream.started_at)}`;
				
				infoContainer.appendChild(channelName);
				infoContainer.appendChild(title);
				infoContainer.appendChild(uptime);
				container.appendChild(thumbnail);
				container.appendChild(infoContainer);
				channelListDiv.appendChild(container);
			});
			
			document.getElementById("generate").style.display = "block";
		}

        function toggleSelection(container, channel) {
            if (selectedChannels.has(channel)) {
                selectedChannels.delete(channel);
                container.classList.remove("selected");
            } else {
                selectedChannels.add(channel);
                container.classList.add("selected");
            }
        }

        document.getElementById("generate").addEventListener("click", () => {
            if (selectedChannels.size > 0) {
                window.open(`https://www.multitwitch.tv/${Array.from(selectedChannels).join("/")}?darkmode`, "_blank");
                selectedChannels.clear();
                document.querySelectorAll(".channel-container").forEach(container => container.classList.remove("selected"));
            } else {
                alert("Select at least one channel.");
            }
        });
		
		
		document.addEventListener("visibilitychange", () => {
			if (!document.hidden) {
				location.reload(); // Refresh the page when tab becomes active again
			}
		});

		// Enhance profile popup after user data retrieval by wrapping existing fetchUserId
        (function(){
            const originalFetchUserId = fetchUserId;
            fetchUserId = async function(){
                try {
                    const response = await fetch("https://api.twitch.tv/helix/users", { headers: { "Authorization": `Bearer ${accessToken}`, "Client-Id": clientId } });
                    const data = await response.json();
                    if (data.data && data.data.length > 0) {
                        userId = data.data[0].id;
                        const user = data.data[0];
                        const profilePic = document.getElementById("profilePic");
                        profilePic.src = user.profile_image_url;
                        const profileContainer = document.getElementById("profileContainer");
                        profileContainer.addEventListener("click", () => {
                            togglePopup(profileContainer, `<div class='profile-row'>${user.display_name} <button id='logoutBtn'>Logout</button></div>`);
                            const btn = document.getElementById('logoutBtn');
                            if(btn){ btn.onclick = logout; }
                        });
                        fetchFollowedChannels();
                    } else { throw new Error("User data not found."); }
                } catch(err){
                    console.error("Error fetching user ID:", err);
                    localStorage.removeItem('twitch_access_token');
                    authenticateTwitch();
                }
            }
        })();

        // Update help button listener to anchor properly
        (function(){
            const helpBtn = document.getElementById('helpBtn');
            helpBtn.replaceWith(helpBtn.cloneNode(true));
            const newHelpBtn = document.getElementById('helpBtn');
            newHelpBtn.addEventListener('click', ()=>{
                togglePopup(newHelpBtn, `<strong>About MultiTwitch Live Selector</strong><br><br>• Select multiple live channels by clicking on them.<br>• Click \"Generate MultiTwitch Link\" to open selected channels in a new tab.<br>• Double-click a channel to open it directly in MultiTwitch.<br><br><span style='opacity:.7'>Support: blake13blake@gmail.com</span>`);
            });
        })();

        checkTwitchLogin();
    </script>

</body>
</html>
